var api = require('api');
var getContext = require('helpers/getContext');
var getTilybotPayload = require('helpers/getTilybotPayload');

const ID = "b34a86df-2aa3-4d06-93bd-8becffe88da0";

var action = 'setWorkType';
async function handler(req, res, next) {
	let payload = getTilybotPayload(req.body.result.fulfillment.messages);
	let responseContext = getContext("worktype-response-followup", req.body.result.contexts);
	let credsContext = getContext("creds", req.body.result.contexts);

	await api.post(
		'/vetting_questions/' + ID + '/answer',
		{ answer: { answer: responseContext.parameters.workType } },
		{
			headers: {
				'X-API-EMAIL': credsContext.parameters.email,
				'X-API-TOKEN': credsContext.parameters.token
			}
		}
	);
	req.log.info('posted response "%s"', responseContext.parameters.workType);
	res.send({
		contextOut: [
			{
				name: 'worktype-response-followup',
				lifespan: 0
			}
		],
		data: { tilybot: payload }
	});
}

module.exports = { action, handler };