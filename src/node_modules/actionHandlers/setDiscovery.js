var api = require('api');
var getContext = require('helpers/getContext');
var getTilybotPayload = require('helpers/getTilybotPayload');

const ID = "dbf887ce-0563-443d-a69a-90ec0ad73df4";

var action = 'setDiscovery';
async function handler(req, res, next) {
	let payload = getTilybotPayload(req.body.result.fulfillment.messages);
	let responseContext = getContext("discovery-response-followup", req.body.result.contexts);
	let credsContext = getContext("creds", req.body.result.contexts);

	await api.post(
		'/vetting_questions/' + ID + '/answer',
		{ answer: { answer: responseContext.parameters.method } },
		{
			headers: {
				'X-API-EMAIL': credsContext.parameters.email,
				'X-API-TOKEN': credsContext.parameters.token
			}
		}
	);
	req.log.info('posted response "%s"', responseContext.parameters.method);
	res.send({
		contextOut: [
			{
				name: 'discovery-response-followup',
				lifespan: 0
			}
		],
		data: { tilybot: payload }
	});
}

module.exports = { action, handler };