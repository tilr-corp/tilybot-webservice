var api = require('api');
var getContext = require('helpers/getContext');
var getTilybotPayload = require('helpers/getTilybotPayload');

var action = 'setDistance';
async function handler(req, res, next) {
	let payload = getTilybotPayload(req.body.result.fulfillment.messages);
	let responseContext = getContext("distance-response-followup", req.body.result.contexts);
	let credsContext = getContext("creds", req.body.result.contexts);

	// await api.put(
	// 	'/users/' + credsContext.parameters.id,
	// 	{
	// 		user_location: {
	// 			distance: responseContext.parameters.distance.num
	// 		}
	// 	},
	// 	{
	// 		headers: {
	// 			'X-API-EMAIL': credsContext.parameters.email,
	// 			'X-API-TOKEN': credsContext.parameters.token
	// 		}
	// 	}
	// );
	req.log.info('posted response "%d"', responseContext.parameters.distance.num);
	res.send({
		contextOut: [
			{
				name: 'distance-response-followup',
				lifespan: 0
			}
		],
		data: { tilybot: payload }
	});
}

module.exports = { action, handler };