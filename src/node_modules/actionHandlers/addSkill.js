var api = require('api');
var getContext = require('helpers/getContext');

var action = 'addSkill';
async function handler(req, res, next) {
	let skillContext = getContext("rateskill-followup", req.body.result.contexts);
	let responseContext = getContext("rateskill-response-followup", req.body.result.contexts);
	let credsContext = getContext("creds", req.body.result.contexts);

	let rating = parseInt(responseContext.parameters.rating);
	req.log.info('gave rating %d to skill ID %s', rating, skillContext.parameters.skill.skill_id);
	if (rating > 0 && rating <= 5) {
		await api.post(
			'/users/' + credsContext.parameters.id + '/skills',
			{
				skills: [
					{ id: skillContext.parameters.skill.skill_id, level: rating }
				]
			},
			{
				headers: {
					'X-API-EMAIL': credsContext.parameters.email,
					'X-API-TOKEN': credsContext.parameters.token
				}
			}
		);
		res.send({ followupEvent: { name: 'RATE_SKILL_RATED' } });
	} else {
		res.send({ followupEvent: { name: 'RATE_SKILL_SKIPPED' } });
	}
}

module.exports = { action, handler };